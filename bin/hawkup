#!/bin/bash
set -e

HAWKUP_DIR="${HAWKUP_DIR:-$(cd "$(dirname "$0")/.." && pwd)}"
export HAWKUP_DIR

sync_configs() {
  if [ -f "$HOME/.bashrc" ] && ! cmp -s "$HOME/.bashrc" "$HAWKUP_DIR/configs/.bashrc"; then
    cp "$HOME/.bashrc" "$HOME/.bashrc.bak" || true
  fi
  cp "$HAWKUP_DIR/configs/.bashrc" "$HOME/.bashrc"

  if [ -f "$HOME/.inputrc" ] && ! cmp -s "$HOME/.inputrc" "$HAWKUP_DIR/configs/.inputrc"; then
    cp "$HOME/.inputrc" "$HOME/.inputrc.bak" || true
  fi
  cp "$HAWKUP_DIR/configs/.inputrc" "$HOME/.inputrc"

  mkdir -p "$HOME/.config"
  if [ -d "$HOME/.config/bash" ]; then
    cp -r "$HOME/.config/bash" "$HOME/.config/bash.bak" || true
  fi
  cp -r "$HAWKUP_DIR/configs/bash" "$HOME/.config/bash"
}

upgrade_apps() {
  for app in "$HAWKUP_DIR"/install/terminal/apps/*.sh; do
    bash "$app"
  done
}

# Shared helpers
source "$HAWKUP_DIR/install/lib/nerdfonts.sh" 2>/dev/null || true
source "$HAWKUP_DIR/install/lib/secrets.sh" 2>/dev/null || true

nf_cli_install_fonts() {
  local v="$1"; shift || true
  if [ "$#" -eq 0 ]; then
    echo "No fonts specified. Try: hawkup nerdfonts list"
    exit 1
  fi
  nf_install_fonts "$v" "$@"
}

case "$1" in
  update)
    sudo apt-get update -y
    sudo apt-get upgrade -y
    ;;
  upgrade)
    sudo apt-get update -y
    sudo apt-get upgrade -y
    upgrade_apps
    ;;
  sync-configs)
    sync_configs
    ;;
  setup-tailscale)
    echo "Setting up Tailscale..."
    curl -fsSL https://tailscale.com/install.sh | sh
    ;;
  install-ai)
    bash "$HAWKUP_DIR/install/terminal/apps/ai.sh"
    ;;
  secrets)
    subcmd="${2:-help}"
    case "$subcmd" in
      add)
        name="$3"; value="$4"
        if [ -z "$name" ]; then echo "Usage: $0 secrets add NAME [VALUE]"; exit 1; fi
        if ! secrets_valid_name "$name"; then echo "Invalid secret name: $name"; exit 1; fi
        secrets_create_if_missing
        if [ -z "$value" ]; then read -rsp "Value for $name: " value; echo; fi
        secrets_set "$name" "$value"
        echo "Set $name in $(secrets_file)"
        echo "Hint: to use it now, run: source ~/.secrets"
        echo "      or: eval \"\$(hawkup secrets env)\""
        echo "      or: eval \"\$(hawkup secrets env $name)\""
        ;;
      list)
        secrets_list
        ;;
      remove)
        name="$3"
        if [ -z "$name" ]; then echo "Usage: $0 secrets remove NAME"; exit 1; fi
        if ! secrets_valid_name "$name"; then echo "Invalid secret name: $name"; exit 1; fi
        secrets_remove "$name"
        echo "Removed $name from $(secrets_file)"
        echo "Hint: to remove from current shell, run: unset $name"
        ;;
      env)
        shift 2 || true
        secrets_env "$@"
        ;;
      *)
        echo "Usage: $0 secrets {add|list|remove|env}"; exit 1
        ;;
    esac
    ;;
  nerdfonts|nerd-fonts|nf)
    subcmd="${2:-help}"
    case "$subcmd" in
      list)
        shift 2 || true
        nf_list_fonts "${1:-$(nf_latest_tag)}"
        ;;
      install)
        shift 2 || true
        v="${NERDFONTS_VERSION:-$(nf_latest_tag)}"
        nf_cli_install_fonts "$v" "$@"
        ;;
      update)
        shift 2 || true
        v="${NERDFONTS_VERSION:-$(nf_latest_tag)}"
        NERDFONTS_FORCE=1 nf_cli_install_fonts "$v" "$@"
        ;;
      *)
        cat <<USAGE
Usage: $0 nerdfonts <list|install|update> [args]
  list [version]             List available fonts (defaults to latest release)
  install <Font...>          Install specific fonts from latest (set NERDFONTS_VERSION to override)
  update <Font...>           Reinstall specified fonts (forces overwrite)

Examples:
  $0 nerdfonts list
  $0 nerdfonts install "JetBrainsMono" "Meslo"
  NERDFONTS_VERSION=v3.4.0 $0 nerdfonts install CascadiaMono
USAGE
        ;;
    esac
    ;;
  *)
    echo "Usage: $0 {update|upgrade|sync-configs|setup-tailscale|install-ai|secrets|nerdfonts}"
    exit 1
    ;;
 esac
